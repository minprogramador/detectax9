<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¤ Microfone ao vivo com frequÃªncia e amplitude</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      text-align: center;
      padding-top: 40px;
    }
    h1 { color: #0ff; }
    canvas { background: #000; margin-top: 20px; }
  </style>
</head>
<body>
  <!-- Liga o microfone, sintonizar com receiver em Freq 281.3 Hz e Amp -35.5dB (proximo do alvo ou aguardar a onda chegar ~~~ escuta NSA com e som autofalante.) -->
  <h1>ğŸ™ï¸ Microfone ao vivo</h1>
  <p id="freq">Freq: -- Hz</p>
  <p id="amp">Amplitude: -- dB</p>
  <canvas id="viz" width="600" height="200"></canvas>

  <script>
    async function startAudio() {
      // ğŸ”Š Pede permissÃ£o e captura Ã¡udio do microfone
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // ğŸ§ Cria contexto de Ã¡udio
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);

      // ğŸ”ˆ SaÃ­da de Ã¡udio (reproduz o som capturado)
      const destination = audioCtx.destination;
      source.connect(destination); // <-- reproduz no alto-falante!

      // ğŸ“Š Cria AnalyserNode para medir frequÃªncia e amplitude
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);

      const dataArray = new Float32Array(analyser.fftSize);
      const freqData = new Uint8Array(analyser.frequencyBinCount);

      const freqLabel = document.getElementById("freq");
      const ampLabel = document.getElementById("amp");
      const canvas = document.getElementById("viz");
      const ctx = canvas.getContext("2d");

      function getDominantFrequency(data, sampleRate) {
        let maxIndex = 0, maxValue = 0;
        for (let i = 0; i < data.length; i++) {
          if (data[i] > maxValue) {
            maxValue = data[i];
            maxIndex = i;
          }
        }
        return (maxIndex * sampleRate) / (2 * data.length);
      }

      function draw() {
        analyser.getFloatTimeDomainData(dataArray);
        analyser.getByteFrequencyData(freqData);

        // ğŸ” Calcula amplitude RMS (em dB)
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
        const rms = Math.sqrt(sum / dataArray.length);
        const amplitudeDb = 20 * Math.log10(rms + 1e-6);

        // ğŸµ Calcula frequÃªncia dominante
        const freq = getDominantFrequency(freqData, audioCtx.sampleRate);

        freqLabel.textContent = `Freq: ${freq.toFixed(1)} Hz`;
        ampLabel.textContent = `Amplitude: ${amplitudeDb.toFixed(1)} dB`;

        // ğŸ“ˆ Desenha o espectro de Ã¡udio
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0f0";
        const barWidth = canvas.width / freqData.length;
        for (let i = 0; i < freqData.length; i++) {
          const barHeight = freqData[i];
          ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth, barHeight);
        }

        requestAnimationFrame(draw);
      }

      draw();
    }

    startAudio().catch(err => {
      alert("Erro ao acessar o microfone: " + err.message);
    });
  </script>
</body>
</html>

